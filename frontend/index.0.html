<!DOCTYPE html>
<html>
<body>

<h2>Upload Image and Save Clicks</h2>

<input type="file" id="imgUploader" name="imgUploader" accept="image/*">
<br>
<img id="uploadedImg" style="max-width: 300px;" hidden>
<br>
<textarea id="textBox" placeholder="Write something here..."></textarea>
<br>
<button id="positiveBtn" onclick="startPositiveSelection()">Start Positive Selection</button>
<button id="negativeBtn" onclick="startNegativeSelection()" hidden>Start Negative Selection</button>
<button id="saveBtn" onclick="saveData()" hidden>Save</button>

<script>
    let imgUploader = document.getElementById('imgUploader');
    let uploadedImg = document.getElementById('uploadedImg');
    let textBox = document.getElementById('textBox');
    let positiveBtn = document.getElementById('positiveBtn');
    let negativeBtn = document.getElementById('negativeBtn');
    let saveBtn = document.getElementById('saveBtn');

    let positivePoints = [];
    let negativePoints = [];
    let selectingPositive = false;

    imgUploader.onchange = function(event) {
        let reader = new FileReader();
        reader.onload = function() {
            if (reader.readyState === 2) {
                uploadedImg.src = reader.result;
                uploadedImg.hidden = false;
            }
        }
        reader.readAsDataURL(event.target.files[0]);
    };

    uploadedImg.onclick = function(event) {
        let rect = event.target.getBoundingClientRect();
        let x = event.clientX - rect.left;
        let y = event.clientY - rect.top;

        if (selectingPositive) {
            positivePoints.push({x: x, y: y});
        } else {
            negativePoints.push({x: x, y: y});
        }
    };

    function startPositiveSelection() {
        selectingPositive = true;
        positiveBtn.hidden = true;
        negativeBtn.hidden = false;
    }

    function startNegativeSelection() {
        selectingPositive = false;
        negativeBtn.hidden = true;
        saveBtn.hidden = false;
    }

    function saveData() {
        let data = {
            text: textBox.value,
            positivePoints: positivePoints,
            negativePoints: negativePoints
        };
        
        let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        let downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "data.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
</script>

</body>
</html>
